<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>密码管理器 · 测试版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #1a1a2e;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 16px;
            font-size: 15px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 1.8rem;
            color: #00b4db;
            margin-bottom: 8px;
        }
        
        /* 测试弹窗 - 强制显示5秒 */
        #test-warning-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 20000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(8px);
        }
        .warning-box {
            background: #1e1e2e;
            border-radius: 20px;
            padding: 32px 24px;
            max-width: 400px;
            width: 100%;
            border: 2px solid #ff6b6b;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .warning-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .warning-title {
            font-size: 1.8rem;
            color: #ff6b6b;
            margin-bottom: 16px;
            font-weight: 700;
        }
        .warning-text {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 28px;
            color: #ddd;
        }
        .warning-timer {
            font-size: 2rem;
            font-weight: 700;
            color: #00b4db;
            margin-bottom: 20px;
        }
        #close-warning-btn {
            background: #444;
            color: #aaa;
            border: none;
            padding: 14px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: not-allowed;
            transition: all 0.2s;
            opacity: 0.5;
        }
        #close-warning-btn.enabled {
            background: #00b4db;
            color: white;
            cursor: pointer;
            opacity: 1;
        }
        #close-warning-btn.enabled:active {
            transform: scale(0.97);
        }

        /* 认证页面 */
        #auth-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
        }
        
        .auth-box {
            background: rgba(30, 30, 46, 0.95);
            border-radius: 12px;
            padding: 30px 20px;
            width: 100%;
            max-width: 420px;
            border: 1px solid #333;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid #333;
        }
        
        .auth-tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            color: #aaa;
            user-select: none;
            min-height: 48px;
            background: transparent;
            border: none;
            transition: color 0.2s;
        }
        
        .auth-tab.active {
            color: #00b4db;
            border-bottom: 3px solid #00b4db;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: #aaa;
        }
        
        input {
            width: 100%;
            padding: 14px 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background: rgba(20, 20, 30, 0.9);
            color: #fff;
            font-size: 1rem;
            -webkit-appearance: none;
        }
        
        input:focus {
            outline: none;
            border-color: #00b4db;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #00b4db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            min-height: 50px;
        }
        
        button:active {
            opacity: 0.8;
            transform: scale(0.99);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        
        button.loading {
            color: transparent;
            position: relative;
        }
        
        button.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            transform: translate(-50%, -50%);
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .error-message {
            color: #ff6b6b;
            background: rgba(255,107,107,0.1);
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            font-size: 0.9rem;
        }

        /* 登录方式切换 (邮箱/手机号) */
        .login-method-switch {
            margin: 15px 0 5px;
            text-align: right;
        }
        .method-link {
            color: #00b4db;
            font-size: 0.9rem;
            text-decoration: none;
            border-bottom: 1px dashed #00b4db;
            cursor: pointer;
            padding: 8px 4px;  /* 增加点击区域 */
            display: inline-block;
            -webkit-tap-highlight-color: transparent;
        }
        .method-link:active {
            opacity: 0.6;
        }

        /* 主界面 */
        #main-section {
            display: none;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(30,30,46,0.9);
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .user-email {
            font-size: 0.95rem;
            color: #a0d2ff;
            word-break: break-all;
        }
        
        .logout-btn {
            width: auto;
            padding: 10px 20px;
            background: #ff6b6b;
            min-width: 100px;
        }
        
        .actions-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 250px;
        }
        
        .add-btn {
            width: auto;
            padding: 12px 20px;
            min-width: 120px;
        }
        
        .password-count {
            color: #aaa;
            font-size: 0.9rem;
            align-self: center;
        }
        
        .passwords-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .password-card {
            background: rgba(30,30,46,0.9);
            border-radius: 10px;
            padding: 18px;
            border: 1px solid #333;
        }
        
        .password-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .password-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #00b4db;
            word-break: break-all;
        }
        
        .password-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.1rem;
            padding: 8px;
            min-width: 40px;
            min-height: 40px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .action-btn:active {
            background: rgba(255,255,255,0.1);
        }
        
        .password-field {
            margin-bottom: 12px;
        }
        
        .field-label {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 4px;
        }
        
        .field-value {
            background: rgba(20,20,30,0.9);
            padding: 12px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .password-text {
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }
        
        .toggle-password {
            background: rgba(0,180,219,0.1);
            border: none;
            color: #00b4db;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            min-height: 36px;
        }
        
        .toggle-password:active {
            background: rgba(0,180,219,0.2);
        }
        
        .password-meta {
            font-size: 0.8rem;
            color: #666;
            margin-top: 12px;
            border-top: 1px solid #333;
            padding-top: 10px;
        }
        
        /* 弹窗 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1e1e2e;
            width: 100%;
            max-width: 480px;
            border-radius: 12px;
            padding: 24px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: #00b4db;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        
        .modal-footer button {
            flex: 1;
            min-width: 100px;
        }
        
        .delete-btn {
            background: #ff6b6b;
        }
        
        .delete-btn.secondary {
            background: transparent;
            border: 1px solid #ff6b6b;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #1e1e2e;
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            transform: translateX(150%);
            transition: transform 0.3s;
            max-width: 350px;
            border-left: 4px solid #00b4db;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.error {
            border-left-color: #ff6b6b;
        }
        
        .toast-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px 8px;
            width: auto;
        }
        
        /* 会话超时警告 */
        #session-timeout-warning {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff9800;
            color: white;
            padding: 16px;
            border-radius: 8px;
            z-index: 10001;
            display: none;
            max-width: 300px;
        }
        
        #session-timeout-warning button {
            margin-top: 12px;
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #00b4db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        /* 密码强度指示器 */
        .password-strength {
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .password-strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
        
        .strength-weak { background-color: #ff6b6b; width: 25%; }
        .strength-medium { background-color: #ffa726; width: 50%; }
        .strength-strong { background-color: #4CAF50; width: 75%; }
        .strength-very-strong { background-color: #00b4db; width: 100%; }
        
        /* 移动端适配 */
        @media (max-width: 600px) {
            body { padding: 12px; }
            h1 { font-size: 1.5rem; }
            .actions-bar { flex-direction: column; }
            .add-btn { width: 100%; }
            .modal-footer { flex-direction: column; }
            .toast { left: 16px; right: 16px; max-width: none; }
        }
    </style>
    
    <!-- 引入Supabase客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ==================== 配置 ====================
        // 【重要】请替换为您自己的Supabase项目URL和anon key
        const SUPABASE_URL = 'https://wxggktbyholsdcexojyp.supabase.co';    // ← 替换这里
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4Z2drdGJ5aG9sc2RjZXhvanlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NTcwMTksImV4cCI6MjA4NzMzMzAxOX0.jqG_LggaZBPXcLm2C1haW-Jt6-eKLAg8esm6M8m_tc8';                   // ← 替换这里
        
        const CONFIG = {
            sessionTimeout: 30 * 60 * 1000,      // 30分钟
            passwordDisplayTimeout: 10 * 1000,    // 10秒
            inactivityTimeout: 5 * 60 * 1000      // 5分钟
        };
        
        // ==================== 全局变量 ====================
        let supabase = null;
        let currentUser = null;
        let userSalt = null;
        let masterKey = null;
        let editingId = null;
        let passwords = [];
        let activityTimer = null;
        let warningTimer = null;
        let sessionTimer = null;
        let displayedPasswords = new Map();
        let lastActivity = Date.now();
        
        // 登录方式切换: true=邮箱模式, false=手机号模式
        let useEmailLogin = true;  
        
        // DOM元素
        const authSection = document.getElementById('auth-section');
        const mainSection = document.getElementById('main-section');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const searchInput = document.getElementById('search-input');
        const passwordCountSpan = document.getElementById('password-count');
        const addPasswordBtn = document.getElementById('add-password-btn');
        const passwordsList = document.getElementById('passwords-list');
        const loadingPasswords = document.getElementById('loading-passwords');
        const sessionTimerSpan = document.getElementById('session-timer');
        const passwordModal = document.getElementById('password-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModal = document.getElementById('close-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const passwordForm = document.getElementById('password-form');
        const deletePasswordBtn = document.getElementById('delete-password-btn');
        const generatePasswordBtn = document.getElementById('generate-password');
        const togglePasswordInput = document.getElementById('toggle-password-input');
        const passwordTitle = document.getElementById('password-title');
        const passwordUsername = document.getElementById('password-username');
        const passwordValue = document.getElementById('password-value');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastClose = document.getElementById('toast-close');
        const sessionTimeoutWarning = document.getElementById('session-timeout-warning');
        const timeoutCountdown = document.getElementById('timeout-countdown');
        const extendSessionBtn = document.getElementById('extend-session-btn');
        const logoutNowBtn = document.getElementById('logout-now-btn');
        const passwordStrengthBar = document.getElementById('password-strength-bar');
        const registerPassword = document.getElementById('register-password');

        // 测试弹窗相关
        const testWarningModal = document.getElementById('test-warning-modal');
        const closeWarningBtn = document.getElementById('close-warning-btn');
        const warningTimerSpan = document.getElementById('warning-timer');
        
        // ==================== 工具函数 ====================
        function showToast(msg, type = 'success') {
            toastMessage.textContent = msg;
            toast.className = 'toast' + (type === 'error' ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input.replace(/[&<>"']/g, function(m) {
                if (m === '&') return '&amp;';
                if (m === '<') return '&lt;';
                if (m === '>') return '&gt;';
                if (m === '"') return '&quot;';
                return '&#39;';
            });
        }
        
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }
        
        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes;
        }
        
        function clearMemory() {
            masterKey = null;
            displayedPasswords.forEach(timer => clearTimeout(timer));
            displayedPasswords.clear();
        }
        
        function checkPasswordStrength(password) {
            if (!password) return 'weak';
            let score = 0;
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;
            if (score <= 2) return 'weak';
            if (score <= 4) return 'medium';
            if (score <= 5) return 'strong';
            return 'very-strong';
        }
        
        function updatePasswordStrength() {
            if (!passwordStrengthBar) return;
            const strength = checkPasswordStrength(registerPassword.value);
            passwordStrengthBar.className = 'password-strength-bar';
            if (!registerPassword.value) {
                passwordStrengthBar.style.width = '0';
                return;
            }
            if (strength === 'weak') passwordStrengthBar.classList.add('strength-weak');
            else if (strength === 'medium') passwordStrengthBar.classList.add('strength-medium');
            else if (strength === 'strong') passwordStrengthBar.classList.add('strength-strong');
            else passwordStrengthBar.classList.add('strength-very-strong');
        }
        
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            } catch {
                return '';
            }
        }
        
        // ==================== 活动监控 ====================
        function updateActivity() {
            if (!currentUser) return;
            lastActivity = Date.now();
            clearTimeout(activityTimer);
            clearTimeout(warningTimer);
            sessionTimeoutWarning.style.display = 'none';
            
            activityTimer = setTimeout(() => {
                sessionTimeoutWarning.style.display = 'block';
                let count = 5;
                timeoutCountdown.textContent = count;
                warningTimer = setInterval(() => {
                    count--;
                    timeoutCountdown.textContent = count;
                    if (count <= 0) {
                        clearInterval(warningTimer);
                        logout();
                    }
                }, 60000);
            }, CONFIG.inactivityTimeout);
        }
        
        // ==================== 加密函数 ====================
        async function generateSalt() {
            const salt = crypto.getRandomValues(new Uint8Array(32));
            return arrayBufferToBase64(salt);
        }
        
        async function deriveKey(password, salt) {
            const passwordBuffer = new TextEncoder().encode(password);
            const saltBuffer = base64ToArrayBuffer(salt);
            
            const key = await crypto.subtle.importKey('raw', passwordBuffer, 'PBKDF2', false, ['deriveKey']);
            
            return await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt: saltBuffer, iterations: 100000, hash: 'SHA-256' },
                key,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        }
        
        async function encrypt(text, key) {
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encoded = new TextEncoder().encode(text);
            const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encoded);
            
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(encrypted), iv.length);
            return arrayBufferToBase64(combined);
        }
        
        async function decrypt(encryptedBase64, key) {
            const combined = base64ToArrayBuffer(encryptedBase64);
            const iv = combined.slice(0, 12);
            const data = combined.slice(12);
            const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, data);
            return new TextDecoder().decode(decrypted);
        }
        
        // ==================== 认证 ====================
        function switchTab(tab) {
            loginTab.classList.remove('active');
            registerTab.classList.remove('active');
            loginForm.classList.remove('active');
            registerForm.classList.remove('active');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                loginForm.classList.add('active');
            } else {
                registerTab.classList.add('active');
                registerForm.classList.add('active');
            }
        }

        // 切换登录方式 (邮箱/手机号)
        function toggleLoginMethod() {
            useEmailLogin = !useEmailLogin;
            const loginMethodText = document.getElementById('login-method-text');
            const loginInput = document.getElementById('login-identifier');
            const switchLink = document.getElementById('switch-login-method');
            
            if (useEmailLogin) {
                loginInput.placeholder = 'your@email.com';
                loginInput.type = 'email';
                switchLink.textContent = '使用手机号登录';
            } else {
                loginInput.placeholder = '手机号码';
                loginInput.type = 'tel';
                switchLink.textContent = '使用邮箱登录';
            }
            loginInput.value = ''; // 清空
            loginError.style.display = 'none';
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const identifier = document.getElementById('login-identifier').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!identifier || !password) {
                loginError.textContent = '请输入账号和密码';
                loginError.style.display = 'block';
                return;
            }
            
            // 构造邮箱：如果是手机号模式且输入的是纯数字，则添加@phone后缀以满足Supabase邮箱格式（演示用）
            let email = identifier;
            if (!useEmailLogin && /^\d+$/.test(identifier)) {
                email = identifier + '@phone.login';  // 手机号转为邮箱格式
            } else if (!useEmailLogin) {
                email = identifier;  // 如果输入了非数字，当作邮箱处理
            }
            
            loginBtn.classList.add('loading');
            loginBtn.disabled = true;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                const { data: saltData, error: saltError } = await supabase
                    .from('user_salts')
                    .select('salt')
                    .eq('user_id', data.user.id)
                    .single();
                
                if (saltError) throw new Error('获取用户盐失败');
                
                userSalt = saltData.salt;
                masterKey = await deriveKey(password, userSalt);
                currentUser = data.user;
                
                document.getElementById('login-password').value = '';
                await loadPasswords();
                showMainUI();
                showToast('登录成功');
                
            } catch (error) {
                loginError.textContent = error.message;
                loginError.style.display = 'block';
                showToast(error.message, 'error');
            } finally {
                loginBtn.classList.remove('loading');
                loginBtn.disabled = false;
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('confirm-password').value;
            
            if (!email || !password) {
                registerError.textContent = '请输入邮箱和密码';
                registerError.style.display = 'block';
                return;
            }
            
            if (password !== confirm) {
                registerError.textContent = '两次密码不一致';
                registerError.style.display = 'block';
                return;
            }
            
            if (password.length < 8) {
                registerError.textContent = '密码至少8位';
                registerError.style.display = 'block';
                return;
            }
            
            registerBtn.classList.add('loading');
            registerBtn.disabled = true;
            
            try {
                const { data, error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                
                const salt = await generateSalt();
                const { error: saltError } = await supabase
                    .from('user_salts')
                    .insert({ user_id: data.user.id, salt });
                
                if (saltError) throw saltError;
                
                masterKey = await deriveKey(password, salt);
                userSalt = salt;
                currentUser = data.user;
                
                document.getElementById('register-password').value = '';
                document.getElementById('confirm-password').value = '';
                
                await loadPasswords();
                showMainUI();
                showToast('注册成功');
                
            } catch (error) {
                registerError.textContent = error.message;
                registerError.style.display = 'block';
                showToast(error.message, 'error');
            } finally {
                registerBtn.classList.remove('loading');
                registerBtn.disabled = false;
            }
        }
        
        async function logout() {
            clearMemory();
            if (activityTimer) clearTimeout(activityTimer);
            if (warningTimer) clearInterval(warningTimer);
            await supabase.auth.signOut();
            currentUser = null;
            authSection.style.display = 'flex';
            mainSection.style.display = 'none';
            sessionTimeoutWarning.style.display = 'none';
            showToast('已退出');
        }
        
        function showMainUI() {
            authSection.style.display = 'none';
            mainSection.style.display = 'block';
            userEmailSpan.textContent = currentUser.email;
            updateActivity();
            
            document.addEventListener('mousemove', updateActivity);
            document.addEventListener('keydown', updateActivity);
            document.addEventListener('click', updateActivity);
            document.addEventListener('touchstart', updateActivity);
            
            setInterval(() => {
                if (currentUser) {
                    const remaining = Math.max(0, CONFIG.sessionTimeout - (Date.now() - lastActivity));
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    sessionTimerSpan.textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
                }
            }, 1000);
        }
        
        // ==================== 密码管理 ====================
        async function loadPasswords() {
            loadingPasswords.style.display = 'block';
            
            const { data, error } = await supabase
                .from('passwords')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });
            
            if (error) {
                showToast('加载失败', 'error');
                passwords = [];
            } else {
                passwords = data || [];
            }
            
            renderPasswords();
            loadingPasswords.style.display = 'none';
        }
        
        function renderPasswords() {
            const filtered = searchInput.value 
                ? passwords.filter(p => p.title.toLowerCase().includes(searchInput.value.toLowerCase()))
                : passwords;
            
            passwordCountSpan.textContent = filtered.length + '个';
            
            if (filtered.length === 0) {
                passwordsList.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#aaa;">暂无密码</div>';
                return;
            }
            
            let html = '';
            filtered.forEach(p => {
                html += `
                    <div class="password-card" data-id="${p.id}">
                        <div class="password-header">
                            <div class="password-title">${escapeHtml(p.title)}</div>
                            <div class="password-actions">
                                <button class="action-btn edit-btn" data-id="${p.id}">✎</button>
                                <button class="action-btn delete-btn" data-id="${p.id}">×</button>
                            </div>
                        </div>
                        <div class="password-field">
                            <div class="field-label">用户名</div>
                            <div class="field-value">
                                <span>${escapeHtml(p.username)}</span>
                            </div>
                        </div>
                        <div class="password-field">
                            <div class="field-label">密码</div>
                            <div class="field-value">
                                <span class="password-text" id="pw-${p.id}">••••••••</span>
                                <button class="toggle-password" data-id="${p.id}" data-enc="${escapeHtml(p.encrypted_password)}">显示</button>
                            </div>
                        </div>
                        <div class="password-meta">${formatDate(p.created_at)}</div>
                    </div>
                `;
            });
            
            passwordsList.innerHTML = html;
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.onclick = () => openModal(passwords.find(p => p.id === btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.onclick = () => deletePassword(btn.dataset.id);
            });
            
            document.querySelectorAll('.toggle-password').forEach(btn => {
                btn.onclick = async () => {
                    const id = btn.dataset.id;
                    const span = document.getElementById(`pw-${id}`);
                    
                    if (btn.textContent === '显示') {
                        try {
                            const decrypted = await decrypt(btn.dataset.enc, masterKey);
                            span.textContent = decrypted;
                            btn.textContent = '隐藏';
                            
                            const timer = setTimeout(() => {
                                if (span.textContent !== '••••••••') {
                                    span.textContent = '••••••••';
                                    btn.textContent = '显示';
                                    displayedPasswords.delete(id);
                                }
                            }, CONFIG.passwordDisplayTimeout);
                            
                            displayedPasswords.set(id, timer);
                            
                        } catch {
                            showToast('解密失败', 'error');
                        }
                    } else {
                        span.textContent = '••••••••';
                        btn.textContent = '显示';
                        if (displayedPasswords.has(id)) {
                            clearTimeout(displayedPasswords.get(id));
                            displayedPasswords.delete(id);
                        }
                    }
                };
            });
        }
        
        function openModal(password = null) {
            if (password) {
                modalTitle.textContent = '编辑密码';
                passwordTitle.value = password.title;
                passwordUsername.value = password.username;
                passwordValue.value = '';
                passwordValue.placeholder = '留空则不修改';
                editingId = password.id;
                deletePasswordBtn.style.display = 'block';
            } else {
                modalTitle.textContent = '添加密码';
                passwordForm.reset();
                passwordValue.placeholder = '输入密码';
                editingId = null;
                deletePasswordBtn.style.display = 'none';
            }
            passwordModal.classList.add('active');
        }
        
        function closeModal() {
            passwordModal.classList.remove('active');
            editingId = null;
        }
        
        async function savePassword(e) {
            e.preventDefault();
            
            const title = passwordTitle.value.trim();
            const username = passwordUsername.value.trim();
            let password = passwordValue.value;
            
            if (!title || !username) {
                showToast('请填写标题和用户名', 'error');
                return;
            }
            
            if (!editingId && !password) {
                showToast('请输入密码', 'error');
                return;
            }
            
            try {
                let encrypted = null;
                
                if (password) {
                    encrypted = await encrypt(password, masterKey);
                } else if (editingId) {
                    const existing = passwords.find(p => p.id === editingId);
                    encrypted = existing.encrypted_password;
                }
                
                const data = {
                    title,
                    username,
                    encrypted_password: encrypted,
                    user_id: currentUser.id
                };
                
                if (editingId) {
                    const { error } = await supabase
                        .from('passwords')
                        .update(data)
                        .eq('id', editingId);
                    
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('passwords')
                        .insert(data);
                    
                    if (error) throw error;
                }
                
                closeModal();
                await loadPasswords();
                showToast(editingId ? '更新成功' : '添加成功');
                
            } catch (error) {
                showToast('保存失败', 'error');
            }
        }
        
        async function deletePassword(id) {
            if (!confirm('确定删除？')) return;
            
            try {
                const { error } = await supabase
                    .from('passwords')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                passwords = passwords.filter(p => p.id !== id);
                renderPasswords();
                showToast('删除成功');
                
            } catch {
                showToast('删除失败', 'error');
            }
        }
        
        function generatePassword() {
            const length = 16;
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            passwordValue.value = result;
            passwordValue.setAttribute('type', 'text');
            togglePasswordInput.textContent = '隐藏';
        }
        
        // ==================== 测试弹窗逻辑 ====================
        function initTestWarning() {
            let seconds = 5;
            warningTimerSpan.textContent = seconds;
            closeWarningBtn.disabled = true;
            closeWarningBtn.classList.remove('enabled');
            
            const timer = setInterval(() => {
                seconds--;
                warningTimerSpan.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(timer);
                    closeWarningBtn.disabled = false;
                    closeWarningBtn.classList.add('enabled');
                }
            }, 1000);
            
            closeWarningBtn.onclick = function() {
                if (!closeWarningBtn.disabled) {
                    testWarningModal.style.display = 'none';
                }
            };
        }
        
        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', async () => {
            // 显示测试弹窗
            initTestWarning();
            
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                
                const { data: saltData } = await supabase
                    .from('user_salts')
                    .select('salt')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (saltData) {
                    userSalt = saltData.salt;
                }
                
                showMainUI();
                await loadPasswords();
            }
            
            // 事件绑定
            loginTab.onclick = () => switchTab('login');
            registerTab.onclick = () => switchTab('register');
            loginForm.onsubmit = handleLogin;
            registerForm.onsubmit = handleRegister;
            logoutBtn.onclick = logout;
            addPasswordBtn.onclick = () => openModal();
            closeModal.onclick = closeModal;
            cancelBtn.onclick = closeModal;
            passwordForm.onsubmit = savePassword;
            generatePasswordBtn.onclick = generatePassword;
            togglePasswordInput.onclick = () => {
                const type = passwordValue.getAttribute('type');
                passwordValue.setAttribute('type', type === 'password' ? 'text' : 'password');
                togglePasswordInput.textContent = type === 'password' ? '隐藏' : '显示';
            };
            toastClose.onclick = () => toast.classList.remove('show');
            extendSessionBtn.onclick = () => {
                updateActivity();
                sessionTimeoutWarning.style.display = 'none';
                showToast('会话已延长');
            };
            logoutNowBtn.onclick = logout;
            
            registerPassword.addEventListener('input', updatePasswordStrength);
            searchInput.addEventListener('input', () => renderPasswords());
            
            // 登录方式切换
            document.getElementById('switch-login-method').addEventListener('click', toggleLoginMethod);
        });
    </script>
</head>
<body>
    <!-- 测试用途警告弹窗 (强制5秒) -->
    <div id="test-warning-modal">
        <div class="warning-box">
            <div class="warning-icon">⚠️</div>
            <div class="warning-title">测试版本</div>
            <div class="warning-text">
                此软件仅用于测试用途。<br><strong>不建议存储真实密码。</strong>
            </div>
            <div class="warning-timer" id="warning-timer">5</div>
            <button id="close-warning-btn" disabled>请等待5秒</button>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>零知识密码管理器</h1>
        </header>
        
        <!-- 认证部分 -->
        <section id="auth-section">
            <div class="auth-box">
                <div class="auth-tabs">
                    <button class="auth-tab active" id="login-tab">登录</button>
                    <button class="auth-tab" id="register-tab">注册</button>
                </div>
                
                <form id="login-form" class="auth-form active">
                    <div class="form-group">
                        <label id="login-label">邮箱 / 手机号</label>
                        <input type="email" id="login-identifier" placeholder="your@email.com" required>
                    </div>
                    <!-- 登录方式切换链接 -->
                    <div class="login-method-switch">
                        <span class="method-link" id="switch-login-method">使用手机号登录</span>
                    </div>
                    <div class="form-group">
                        <label>主密码</label>
                        <input type="password" id="login-password" placeholder="输入主密码" required>
                    </div>
                    <button type="submit" id="login-btn">登录</button>
                    <div class="error-message" id="login-error"></div>
                </form>
                
                <form id="register-form" class="auth-form">
                    <div class="form-group">
                        <label>邮箱</label>
                        <input type="email" id="register-email" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label>主密码</label>
                        <input type="password" id="register-password" placeholder="至少8位" required minlength="8">
                        <div class="password-strength">
                            <div class="password-strength-bar" id="password-strength-bar"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>确认密码</label>
                        <input type="password" id="confirm-password" placeholder="再次输入主密码" required>
                    </div>
                    <button type="submit" id="register-btn">注册</button>
                    <div class="error-message" id="register-error"></div>
                </form>
            </div>
        </section>
        
        <!-- 主界面 -->
        <section id="main-section">
            <div class="user-info">
                <div>
                    <div>密码库</div>
                    <div class="user-email" id="user-email"></div>
                </div>
                <div>
                    <div id="session-timer" style="font-size:0.85rem; color:#aaa;">30:00</div>
                    <button class="logout-btn" id="logout-btn">退出</button>
                </div>
            </div>
            
            <div class="actions-bar">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="搜索...">
                </div>
                <button class="add-btn" id="add-password-btn">+ 添加</button>
                <div class="password-count" id="password-count">0</div>
            </div>
            
            <div id="passwords-container">
                <div class="loading" id="loading-passwords">
                    <div class="spinner"></div>
                    <p>加载中...</p>
                </div>
                <div class="passwords-list" id="passwords-list"></div>
            </div>
        </section>
        
        <!-- 密码弹窗 -->
        <div class="modal" id="password-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modal-title">添加密码</h3>
                    <button class="close-modal" id="close-modal">&times;</button>
                </div>
                <form id="password-form">
                    <div class="form-group">
                        <label>标题</label>
                        <input type="text" id="password-title" placeholder="例如: Gmail" required>
                    </div>
                    <div class="form-group">
                        <label>用户名</label>
                        <input type="text" id="password-username" placeholder="用户名或邮箱" required>
                    </div>
                    <div class="form-group">
                        <label>密码</label>
                        <input type="password" id="password-value" placeholder="输入密码" required>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button type="button" id="generate-password" style="flex:1; padding:10px;">生成</button>
                            <button type="button" id="toggle-password-input" style="flex:1; padding:10px;">显示</button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" id="save-password-btn">保存</button>
                        <button type="button" id="cancel-btn">取消</button>
                        <button type="button" id="delete-password-btn" class="delete-btn secondary" style="display:none;">删除</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Toast提示 -->
        <div class="toast" id="toast">
            <div class="toast-content">
                <span id="toast-message"></span>
                <button class="toast-close" id="toast-close">&times;</button>
            </div>
        </div>
        
        <!-- 会话超时警告 -->
        <div id="session-timeout-warning">
            <div>即将超时</div>
            <p>将在 <span id="timeout-countdown">5</span> 分钟后自动退出</p>
            <div style="display: flex; gap: 8px;">
                <button id="extend-session-btn">保持登录</button>
                <button id="logout-now-btn" style="background:transparent; border:1px solid white;">退出</button>
            </div>
        </div>
    </div>
</body>
</html>
